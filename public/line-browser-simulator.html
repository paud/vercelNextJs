<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE æµè§ˆå™¨æ¨¡æ‹Ÿå™¨ - LIFF è°ƒè¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .simulator-container {
            display: flex;
            flex-direction: row;
            height: 100vh;
        }

        .control-panel {
            background: linear-gradient(135deg, #06c755 0%, #00b900 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 2px 0 16px rgba(0, 0, 0, 0.08);
            width: 340px;
            min-width: 280px;
            max-width: 400px;
            height: 100vh;
            border-radius: 0 16px 16px 0;
            display: flex;
            flex-direction: column;
        }

        .control-panel h1 {
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-panel h1::before {
            content: 'ğŸ“±';
            font-size: 24px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 12px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .control-group label {
            font-size: 13px;
            font-weight: 500;
        }

        .control-group input,
        .control-group select {
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            background: white;
            color: #333;
        }

        .control-group input {
            min-width: 300px;
        }

        .control-group select {
            cursor: pointer;
            min-width: 150px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button.primary {
            background: white;
            color: #06c755;
        }

        button.primary:hover {
            background: #f0f0f0;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        button.secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        button.secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .device-frame {
            flex: 1;
            height: 100vh;
            align-items: center;
            justify-content: center;
            display: flex;
        }

        .phone-mockup {
            position: relative;
            width: 375px;
            height: 667px;
            background: #000;
            border-radius: 40px;
            padding: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .phone-mockup.tablet {
            width: 768px;
            height: 1024px;
        }

        .phone-mockup.desktop {
            width: 1200px;
            height: 800px;
            border-radius: 20px;
        }

        .phone-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 25px;
            background: #000;
            border-radius: 0 0 20px 20px;
            z-index: 10;
        }

        .line-header {
            background: #06c755;
            color: white;
            padding: 12px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .line-header-title {
            flex: 1;
            text-align: center;
        }

        .line-header-icon {
            font-size: 20px;
        }

        .iframe-container {
            flex: 1;
            background: white;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            position: relative;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .status-bar {
            background: rgba(0, 0, 0, 0.05);
            padding: 10px;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #e0e0e0;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }

        .status-item strong {
            color: #333;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(6, 199, 85, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-size: 12px;
            color: #333;
        }

        .info-panel h3 {
            font-size: 13px;
            margin-bottom: 8px;
            color: #06c755;
        }

        .info-panel ul {
            list-style: none;
            padding-left: 0;
        }

        .info-panel li {
            padding: 4px 0;
            padding-left: 16px;
            position: relative;
        }

        .info-panel li::before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: #06c755;
        }

        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .spinner {
            border: 3px solid rgba(6, 199, 85, 0.1);
            border-top: 3px solid #06c755;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1400px) {
            .phone-mockup.desktop {
                width: 1000px;
                height: 700px;
            }
        }

        @media (max-width: 1100px) {
            .phone-mockup {
                width: 360px;
                height: 640px;
            }
            .phone-mockup.tablet {
                width: 600px;
                height: 800px;
            }
            .phone-mockup.desktop {
                width: 800px;
                height: 600px;
            }
        }
    </style>
</head>
<body>
    <div class="simulator-container" style="display: flex; flex-direction: row; height: 100vh;">
        <!-- æ§åˆ¶é¢æ¿å·¦ä¾§ -->
        <div class="control-panel" style="width: 340px; min-width: 280px; max-width: 400px; height: 100vh; border-radius: 0 16px 16px 0; box-shadow: 2px 0 16px rgba(0,0,0,0.08); display: flex; flex-direction: column;">
            <h1>LINE æµè§ˆå™¨æ¨¡æ‹Ÿå™¨</h1>
            
            <div class="controls">
                <div class="control-group">
                    <label>ğŸ“ URL:</label>
                    <input type="text" id="urlInput" placeholder="è¾“å…¥è¦è°ƒè¯•çš„ URL (ä¾‹å¦‚: http://localhost:3000)" />
                </div>
                
                <div class="control-group">
                    <label>ğŸ“± è®¾å¤‡:</label>
                    <select id="deviceSelect">
                        <option value="mobile">ç§»åŠ¨ç«¯ (375x667)</option>
                        <option value="tablet">å¹³æ¿ (768x1024)</option>
                        <option value="desktop">æ¡Œé¢ç«¯ (1200x800)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>ğŸŒ User Agent:</label>
                    <select id="uaSelect">
                        <option value="line-ios">LINE iOS</option>
                        <option value="line-android">LINE Android</option>
                        <option value="chrome">Chrome (æµ‹è¯•)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>ğŸ” LIFF çŠ¶æ€:</label>
                    <select id="liffAuthStatus">
                        <option value="authorized">å·²æˆæƒ (å·²ç™»å½•)</option>
                        <option value="unauthorized">æœªæˆæƒ (æœªç™»å½•)</option>
                        <option value="expired">Token è¿‡æœŸ</option>
                    </select>
                </div>
            </div>

            <div class="button-group" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <button class="primary" onclick="loadUrl()">ğŸš€ åŠ è½½é¡µé¢</button>
                    <button class="secondary" onclick="reloadIframe()">ğŸ”„ åˆ·æ–°</button>
                    <button class="secondary" onclick="simulateLineLogin()">ğŸ‘¤ æ¨¡æ‹Ÿç™»å½• LINE</button>
                    <button class="secondary" onclick="simulateLiffAuthorize()">ğŸ” æ¨¡æ‹Ÿæˆæƒ</button>
                    <button class="secondary" onclick="simulateLiffLogout()">ğŸšª æ¨¡æ‹Ÿç™»å‡º</button>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="secondary" onclick="clearCache()">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
                    <button class="secondary" onclick="openDevTools()">ğŸ”§ å¼€å‘è€…å·¥å…·</button>
                    <button class="secondary" onclick="copyUrl()">ğŸ“‹ å¤åˆ¶ URL</button>
                    <button class="secondary" onclick="activateTestMode()">ğŸ§ª æ¿€æ´»æµ‹è¯•æ¨¡å¼</button>
                </div>
            </div>
        </div>
        <!-- è®¾å¤‡æ¨¡æ‹Ÿå™¨å³ä¾§ -->
        <div class="device-frame" style="flex: 1; height: 100vh; align-items: center; justify-content: center; display: flex;">
            <div class="phone-mockup" id="phoneMockup">
                <div class="phone-notch"></div>
                <div class="line-header">
                    <span class="line-header-icon">â†</span>
                    <span class="line-header-title">LINE</span>
                    <span class="line-header-icon">â‹®</span>
                </div>
                <div class="iframe-container">
                    <div class="loading-indicator" id="loadingIndicator">
                        <div class="spinner"></div>
                        <div>åŠ è½½ä¸­...</div>
                    </div>
                    <iframe id="appIframe" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-modals"></iframe>
                </div>
                <div class="status-bar" id="statusBar">
                    <div class="status-item">
                        <span><strong>çŠ¶æ€:</strong> <span id="statusText">ç­‰å¾…åŠ è½½</span></span>
                    </div>
                    <div class="status-item">
                        <span><strong>LIFF æˆæƒ:</strong> <span id="liffAuthText">æœªæˆæƒ</span></span>
                    </div>
                    <div class="status-item">
                        <span><strong>User Agent:</strong> <span id="uaText">æœªè®¾ç½®</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // User Agent é…ç½®
        const USER_AGENTS = {
            'line-ios': 'Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 Safari Line/13.1.1',
            'line-android': 'Mozilla/5.0 (Linux; Android 12; Pixel 6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Mobile Safari/537.36 Line/12.1.1',
            'chrome': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36'
        };

        // æ¨¡æ‹Ÿ LIFF ç”¨æˆ·æ•°æ®
        const MOCK_LIFF_USER = {
            userId: 'U' + Math.random().toString(36).substr(2, 32),
            displayName: 'æµ‹è¯•ç”¨æˆ·',
            pictureUrl: 'https://via.placeholder.com/200',
            statusMessage: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è´¦å·'
        };

        // æ¨¡æ‹Ÿ Access Token
        const MOCK_ACCESS_TOKEN = 'mock_access_token_' + Math.random().toString(36).substr(2, 64);
        const MOCK_ID_TOKEN = 'mock_id_token_' + Math.random().toString(36).substr(2, 64);

        // é»˜è®¤åŠ è½½æœ¬åœ°å¼€å‘åœ°å€
        const defaultUrl = window.location.origin.includes('localhost') || window.location.origin.includes('127.0.0.1')
            ? 'http://localhost:3000'
            : window.location.origin;

        document.getElementById('urlInput').value = defaultUrl;

        // è·å–å½“å‰æˆæƒçŠ¶æ€
        function getLiffAuthStatus() {
            return document.getElementById('liffAuthStatus').value;
        }

        // æ›´æ–°æˆæƒçŠ¶æ€æ˜¾ç¤º
        function updateAuthStatusDisplay() {
            const status = getLiffAuthStatus();
            const liffAuthText = document.getElementById('liffAuthText');
            // æ³¨å…¥ User Agentï¼Œæ— è®ºæˆæƒä¸å¦éƒ½æ¨¡æ‹Ÿåœ¨ LINE App å†…
            updateUserAgentDisplay();
            // æœªæˆæƒæ—¶æ¸…é™¤ tokenï¼Œä¿ç•™ User Agent
            if (status === 'unauthorized') {
                localStorage.removeItem('liff_mock_data');
                localStorage.removeItem('mock_access_token');
            }
            switch(status) {
                case 'authorized':
                    liffAuthText.textContent = 'âœ… å·²æˆæƒ';
                    liffAuthText.style.color = '#06c755';
                    break;
                case 'unauthorized':
                    liffAuthText.textContent = 'âŒ æœªæˆæƒ';
                    liffAuthText.style.color = '#ff6b6b';
                    break;
                case 'expired':
                    liffAuthText.textContent = 'âš ï¸ Token è¿‡æœŸ';
                    liffAuthText.style.color = '#ff9800';
                    break;
            }
        }

        // æ¨¡æ‹Ÿ LIFF ç™»å½•
        function simulateLiffLogin() {
            const status = getLiffAuthStatus();
            if (status === 'unauthorized') {
                alert('âŒ å½“å‰ LIFF çŠ¶æ€è®¾ç½®ä¸º"æœªæˆæƒ"ï¼Œè¯·å…ˆå°†çŠ¶æ€æ”¹ä¸º"å·²æˆæƒ"åå†æ¨¡æ‹Ÿç™»å½•');
                return;
            }

            // è®¾ç½®æ¨¡æ‹Ÿçš„ LIFF æ•°æ®åˆ° localStorage
            try {
                // é‡æ–°ç”Ÿæˆ tokenï¼Œç¡®ä¿æ¯æ¬¡æ¨¡æ‹Ÿç™»å½•éƒ½å”¯ä¸€
                const accessToken = 'mock_access_token_' + Math.random().toString(36).substr(2, 64);
                const idToken = 'mock_id_token_' + Math.random().toString(36).substr(2, 64);
                const liffData = {
                    user: MOCK_LIFF_USER,
                    accessToken: accessToken,
                    idToken: idToken,
                    isLoggedIn: true,
                    expiresAt: status === 'expired' ? Date.now() - 1000 : Date.now() + 3600000, // 1å°æ—¶åè¿‡æœŸ
                    context: {
                        type: 'utou',
                        viewType: 'full',
                        userId: MOCK_LIFF_USER.userId,
                        utouId: 'U' + Math.random().toString(36).substr(2, 32)
                    }
                };
                localStorage.setItem('liff_mock_data', JSON.stringify(liffData));
                localStorage.setItem('mock_access_token', accessToken); // åŒæ­¥å†™å…¥ mock_access_token
                // é€šçŸ¥ iframe
                notifyIframe({
                    type: 'liff-auth-changed',
                    status: 'authorized',
                    user: MOCK_LIFF_USER,
                    accessToken: accessToken,
                    idToken: idToken
                });
                updateAuthStatusDisplay();
                console.log('âœ… LIFF ç™»å½•æ¨¡æ‹ŸæˆåŠŸ');
                console.log('ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯:', MOCK_LIFF_USER);
                console.log('ğŸ”‘ Access Token:', accessToken.substring(0, 30) + '...');
                alert('âœ… LIFF ç™»å½•æ¨¡æ‹ŸæˆåŠŸï¼\n\n' +
                      'ç”¨æˆ·ID: ' + MOCK_LIFF_USER.userId.substring(0, 20) + '...\n' +
                      'æ˜¾ç¤ºåç§°: ' + MOCK_LIFF_USER.displayName + '\n\n' +
                      'é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ä»¥åº”ç”¨æ–°çš„ç™»å½•çŠ¶æ€');
                // åˆ·æ–° iframe
                setTimeout(() => reloadIframe(), 1000);
            } catch (e) {
                console.error('âŒ æ¨¡æ‹Ÿç™»å½•å¤±è´¥:', e);
                alert('âŒ æ¨¡æ‹Ÿç™»å½•å¤±è´¥: ' + e.message);
            }
        }

        // æ¨¡æ‹Ÿ LIFF ç™»å‡º
        function simulateLiffLogout() {
            try {
                // æ¸…é™¤æ¨¡æ‹Ÿçš„ LIFF æ•°æ®
                localStorage.removeItem('liff_mock_data');
                
                // é€šçŸ¥ iframe
                notifyIframe({
                    type: 'liff-auth-changed',
                    status: 'unauthorized',
                    user: null
                });

                // æ›´æ–°çŠ¶æ€é€‰æ‹©å™¨
                document.getElementById('liffAuthStatus').value = 'unauthorized';
                updateAuthStatusDisplay();
                
                console.log('âœ… LIFF ç™»å‡ºæ¨¡æ‹ŸæˆåŠŸ');
                
                alert('âœ… LIFF ç™»å‡ºæ¨¡æ‹ŸæˆåŠŸï¼\n\né¡µé¢å°†è‡ªåŠ¨åˆ·æ–°');
                
                // åˆ·æ–° iframe
                setTimeout(() => reloadIframe(), 1000);
            } catch (e) {
                console.error('âŒ æ¨¡æ‹Ÿç™»å‡ºå¤±è´¥:', e);
                alert('âŒ æ¨¡æ‹Ÿç™»å‡ºå¤±è´¥: ' + e.message);
            }
        }

        // æ¨¡æ‹Ÿç™»å½• LINEï¼ˆåªè®¾ç½® User Agentï¼Œä¸å†™å…¥ tokenï¼‰
        function simulateLineLogin() {
            // åªåˆ·æ–° User Agentï¼Œä¸å†™å…¥ä»»ä½• token
            updateUserAgentDisplay();
            localStorage.removeItem('liff_mock_data');
            localStorage.removeItem('mock_access_token');
            alert('å·²æ¨¡æ‹Ÿç™»å½• LINEï¼ˆä»…è®¾ç½® User Agentï¼Œæœªæˆæƒç½‘é¡µï¼‰ã€‚\nè¯·åˆ·æ–°é¡µé¢æµ‹è¯•é¦–æ¬¡è®¿é—®åœºæ™¯ã€‚');
            reloadIframe();
        }

        // æ¨¡æ‹Ÿ LIFF æˆæƒï¼ˆå†™å…¥ tokenï¼‰
        function simulateLiffAuthorize() {
            const status = getLiffAuthStatus();
            if (status !== 'authorized' && status !== 'expired') {
                alert('è¯·å…ˆå°† LIFF çŠ¶æ€åˆ‡æ¢ä¸ºâ€œå·²æˆæƒâ€æˆ–â€œToken è¿‡æœŸâ€å†æ¨¡æ‹Ÿæˆæƒ');
                return;
            }
            try {
                const accessToken = 'mock_access_token_' + Math.random().toString(36).substr(2, 64);
                const idToken = 'mock_id_token_' + Math.random().toString(36).substr(2, 64);
                const liffData = {
                    user: MOCK_LIFF_USER,
                    accessToken: accessToken,
                    idToken: idToken,
                    isLoggedIn: true,
                    expiresAt: status === 'expired' ? Date.now() - 1000 : Date.now() + 3600000,
                    context: {
                        type: 'utou',
                        viewType: 'full',
                        userId: MOCK_LIFF_USER.userId,
                        utouId: 'U' + Math.random().toString(36).substr(2, 32)
                    }
                };
                localStorage.setItem('liff_mock_data', JSON.stringify(liffData));
                localStorage.setItem('mock_access_token', accessToken);
                notifyIframe({
                    type: 'liff-auth-changed',
                    status: 'authorized',
                    user: MOCK_LIFF_USER,
                    accessToken: accessToken,
                    idToken: idToken
                });
                updateAuthStatusDisplay();
                alert('âœ… LIFF æˆæƒæ¨¡æ‹ŸæˆåŠŸï¼\né¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ä»¥åº”ç”¨æ–°çš„æˆæƒçŠ¶æ€ã€‚');
                setTimeout(() => reloadIframe(), 1000);
            } catch (e) {
                console.error('âŒ æ¨¡æ‹Ÿæˆæƒå¤±è´¥:', e);
                alert('âŒ æ¨¡æ‹Ÿæˆæƒå¤±è´¥: ' + e.message);
            }
        }

        // é€šçŸ¥ iframe
        function notifyIframe(message) {
            const iframe = document.getElementById('appIframe');
            if (iframe && iframe.contentWindow) {
                try {
                    iframe.contentWindow.postMessage(message, '*');
                    console.log('ğŸ“¤ å‘é€æ¶ˆæ¯åˆ° iframe:', message);
                } catch (e) {
                    console.warn('âš ï¸ æ— æ³•å‘é€æ¶ˆæ¯åˆ° iframe:', e.message);
                }
            }
        }

        // åŠ è½½ URL
        function loadUrl() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) {
                alert('è¯·è¾“å…¥ URL');
                return;
            }

            const iframe = document.getElementById('appIframe');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const statusText = document.getElementById('statusText');

            loadingIndicator.style.display = 'block';
            statusText.textContent = 'åŠ è½½ä¸­...';

            // æ ¹æ®æˆæƒçŠ¶æ€è®¾ç½®æ¨¡æ‹Ÿæ•°æ®
            const authStatus = getLiffAuthStatus();
            if (authStatus === 'authorized' || authStatus === 'expired') {
                // é¢„å…ˆè®¾ç½® LIFF æ¨¡æ‹Ÿæ•°æ®
                const liffData = {
                    user: MOCK_LIFF_USER,
                    accessToken: MOCK_ACCESS_TOKEN,
                    idToken: MOCK_ID_TOKEN,
                    isLoggedIn: true,
                    expiresAt: authStatus === 'expired' ? Date.now() - 1000 : Date.now() + 3600000,
                    context: {
                        type: 'utou',
                        viewType: 'full',
                        userId: MOCK_LIFF_USER.userId,
                        utouId: 'U' + Math.random().toString(36).substr(2, 32)
                    }
                };
                localStorage.setItem('liff_mock_data', JSON.stringify(liffData));
            } else {
                // æ¸…é™¤ LIFF æ¨¡æ‹Ÿæ•°æ®
                localStorage.removeItem('liff_mock_data');
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            iframe.onload = function() {
                loadingIndicator.style.display = 'none';
                statusText.textContent = 'å·²åŠ è½½';
                
                // å°è¯•æ³¨å…¥ LIFF ç¯å¢ƒä¿¡æ¯åˆ° iframe (å¦‚æœåŒæº)
                try {
                    const iframeWindow = iframe.contentWindow;
                    if (iframeWindow) {
                        // è®¾ç½®ä¸€äº›è°ƒè¯•ä¿¡æ¯
                        console.log('âœ… iframe åŠ è½½æˆåŠŸ');
                        console.log('ğŸ“ URL:', url);
                        console.log('ğŸŒ User Agent:', getCurrentUserAgent());
                        console.log('ğŸ” LIFF çŠ¶æ€:', authStatus);
                        
                        // å‘é€åˆå§‹æˆæƒçŠ¶æ€
                        notifyIframe({
                            type: 'liff-init',
                            status: authStatus,
                            user: authStatus === 'authorized' || authStatus === 'expired' ? MOCK_LIFF_USER : null
                        });
                    }
                } catch (e) {
                    console.warn('âš ï¸ æ— æ³•è®¿é—® iframe (å¯èƒ½æ˜¯è·¨åŸŸ):', e.message);
                }
            };

            iframe.onerror = function() {
                loadingIndicator.style.display = 'none';
                statusText.textContent = 'åŠ è½½å¤±è´¥';
                alert('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ URL æ˜¯å¦æ­£ç¡®');
            };

            iframe.src = url;
            updateUserAgentDisplay();
            updateAuthStatusDisplay();
        }

        // åˆ·æ–° iframe
        function reloadIframe() {
            const iframe = document.getElementById('appIframe');
            if (iframe.src) {
                iframe.src = iframe.src;
            } else {
                loadUrl();
            }
        }

        // æ¸…é™¤ç¼“å­˜
        function clearCache() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½å—ï¼Ÿ')) {
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                } catch (e) {
                    console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', e);
                }
                
                // é‡æ–°åŠ è½½
                const iframe = document.getElementById('appIframe');
                const timestamp = new Date().getTime();
                const url = document.getElementById('urlInput').value;
                
                if (url) {
                    const separator = url.includes('?') ? '&' : '?';
                    iframe.src = url + separator + '_t=' + timestamp;
                }
            }
        }

        // æ‰“å¼€å¼€å‘è€…å·¥å…·æç¤º
        function openDevTools() {
            alert('ğŸ’¡ ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·:\n\n' +
                  '1. æŒ‰ F12 æˆ– å³é”® > æ£€æŸ¥å…ƒç´ \n' +
                  '2. åœ¨ Console ä¸­å¯ä»¥æŸ¥çœ‹æ—¥å¿—\n' +
                  '3. åœ¨ Network ä¸­å¯ä»¥æŸ¥çœ‹ç½‘ç»œè¯·æ±‚\n' +
                  '4. åœ¨ Application ä¸­å¯ä»¥æŸ¥çœ‹å­˜å‚¨æ•°æ®\n\n' +
                  'æ³¨æ„: iframe å†…çš„å†…å®¹éœ€è¦åœ¨ iframe ä¸Šä¸‹æ–‡ä¸­è°ƒè¯•');
        }

        // å¤åˆ¶ URL
        function copyUrl() {
            const url = document.getElementById('urlInput').value;
            navigator.clipboard.writeText(url).then(() => {
                alert('âœ… URL å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }

        // æ¿€æ´»æµ‹è¯•æ¨¡å¼
        function activateTestMode() {
            try {
                sessionStorage.setItem('liff_test_active', 'true');
                window.__LIFF_TEST_MODE__ = true;
                alert('æµ‹è¯•æ¨¡å¼å·²æ¿€æ´»ï¼\n\nè¯·åˆ·æ–°é¡µé¢ä»¥ç”Ÿæ•ˆã€‚\n\næ­¤åå°†å¼ºåˆ¶è¯†åˆ«ä¸º LINE ç¯å¢ƒï¼Œå¯ç”¨äºæœ¬åœ°è°ƒè¯•ã€‚');
            } catch (e) {
                alert('æ¿€æ´»æµ‹è¯•æ¨¡å¼å¤±è´¥: ' + e.message);
            }
        }

        // è·å–å½“å‰ User Agent
        function getCurrentUserAgent() {
            const uaSelect = document.getElementById('uaSelect').value;
            return USER_AGENTS[uaSelect];
        }

        // æ›´æ–° User Agent æ˜¾ç¤º
        function updateUserAgentDisplay() {
            const uaText = document.getElementById('uaText');
            const currentUA = getCurrentUserAgent();
            const shortUA = currentUA.substring(0, 50) + '...';
            uaText.textContent = shortUA;
            uaText.title = currentUA;
        }

        // è®¾å¤‡å°ºå¯¸åˆ‡æ¢
        document.getElementById('deviceSelect').addEventListener('change', function(e) {
            const phoneMockup = document.getElementById('phoneMockup');
            phoneMockup.className = 'phone-mockup';
            
            if (e.target.value === 'tablet') {
                phoneMockup.classList.add('tablet');
            } else if (e.target.value === 'desktop') {
                phoneMockup.classList.add('desktop');
            }
        });

        // User Agent åˆ‡æ¢
        document.getElementById('uaSelect').addEventListener('change', function() {
            updateUserAgentDisplay();
            
            // æç¤ºç”¨æˆ·é‡æ–°åŠ è½½
            if (document.getElementById('appIframe').src) {
                if (confirm('User Agent å·²æ›´æ”¹ï¼Œæ˜¯å¦é‡æ–°åŠ è½½é¡µé¢ï¼Ÿ')) {
                    reloadIframe();
                }
            }
        });

        // LIFF æˆæƒçŠ¶æ€åˆ‡æ¢
        document.getElementById('liffAuthStatus').addEventListener('change', function() {
            updateAuthStatusDisplay();
            
            const status = getLiffAuthStatus();
            console.log('ğŸ” LIFF çŠ¶æ€å·²æ›´æ”¹ä¸º:', status);
            
            // æç¤ºç”¨æˆ·é‡æ–°åŠ è½½
            if (document.getElementById('appIframe').src) {
                if (confirm('LIFF æˆæƒçŠ¶æ€å·²æ›´æ”¹ï¼Œæ˜¯å¦é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨æ–°çŠ¶æ€ï¼Ÿ')) {
                    reloadIframe();
                }
            }
        });

        // URL è¾“å…¥æ¡†å›è½¦åŠ è½½
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadUrl();
            }
        });

        // åˆå§‹åŒ–
        updateUserAgentDisplay();
        updateAuthStatusDisplay();

        // æ·»åŠ æ§åˆ¶å°æ—¥å¿—
        console.log('%cğŸš€ LINE æµè§ˆå™¨æ¨¡æ‹Ÿå™¨å·²å¯åŠ¨', 'color: #06c755; font-size: 16px; font-weight: bold;');
        console
        console.log('%cğŸ“± å½“å‰ User Agent:', 'color: #06c755; font-weight: bold;');
        console.log(getCurrentUserAgent());
        console.log('%cğŸ” å½“å‰ LIFF çŠ¶æ€:', 'color: #06c755; font-weight: bold;');
        console.log(getLiffAuthStatus());

        // ç›‘å¬ iframe æ¶ˆæ¯ (ç”¨äºè·¨åŸŸé€šä¿¡)
        window.addEventListener('message', function(event) {
            console.log('ğŸ“¨ æ”¶åˆ° iframe æ¶ˆæ¶ˆæ¯:', event.data);
            
            // å¤„ç†æ¥è‡ª iframe çš„æ¶ˆæ¯
            if (event.data && event.data.type === 'liff-status') {
                console.log('LIFF çŠ¶æ€:', event.data.status);
            }
            
            // å“åº” LIFF æ•°æ®è¯·æ±‚
            if (event.data && event.data.type === 'request-liff-data') {
                const authStatus = getLiffAuthStatus();
                const response = {
                    type: 'liff-data-response',
                    status: authStatus,
                    user: authStatus === 'authorized' || authStatus === 'expired' ? MOCK_LIFF_USER : null,
                    accessToken: authStatus === 'authorized' || authStatus === 'expired' ? MOCK_ACCESS_TOKEN : null,
                    idToken: authStatus === 'authorized' || authStatus === 'expired' ? MOCK_ID_TOKEN : null,
                    isExpired: authStatus === 'expired'
                };
                
                event.source.postMessage(response, event.origin);
                console.log('ğŸ“¤ è¿”å› LIFF æ•°æ®ç»™ iframe:', response);
            }
        });

        // è‡ªåŠ¨åŠ è½½é»˜è®¤ URLï¼ˆå¯é€‰ï¼‰
        if (defaultUrl) {
            console.log('ğŸ”„ è‡ªåŠ¨åŠ è½½é»˜è®¤ URL:', defaultUrl);
            // setTimeout(() => loadUrl(), 500); // å–æ¶ˆæ³¨é‡Šä»¥è‡ªåŠ¨åŠ è½½
        }
    </script>
</body>
</html>
